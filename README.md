# Лабораторная работа №1
## Проектирование базы данных маркетплейса

## Цель работы

Спроектировать и реализовать реляционную базу данных для упрощённой системы маркетплейса с соблюдением инвариантов целостности данных и использованием ограничений СУБД.

Работа выполняется в **PostgreSQL**.

## Постановка задачи

Вам необходимо разработать схему базы данных для маркетплейса, поддерживающего:

- регистрацию пользователей
- создание заказов
- добавление товаров в заказ
- изменение статусов заказов
- хранение истории изменения статусов

База данных должна обеспечивать целостность данных на уровне самой СУБД (а не только логикой приложения).

## Функциональные требования

### 1. Пользователи (Users)

Каждый пользователь должен иметь:
- уникальный идентификатор
- email (уникальный)
- имя
- дату регистрации

### 2. Заказы (Orders)

Каждый заказ должен:
- принадлежать одному пользователю
- иметь дату создания
- иметь текущий статус
- иметь итоговую сумму

### 3. Позиции заказа (Order Items)

Каждая позиция заказа должна:
- принадлежать конкретному заказу
- содержать название товара
- содержать цену на момент покупки
- содержать количество
- позволять вычислить стоимость позиции

### 4. Статусы заказа (Order Statuses)

Система должна поддерживать статусы (например):
- `created`
- `paid`
- `cancelled`
- `shipped`
- `completed`

Статусы должны храниться в отдельной таблице.

### 5. История изменения статусов (Order Status History)

Каждое изменение статуса должно:
- ссылаться на заказ
- ссылаться на статус
- хранить дату изменения
- фиксироваться при каждом переходе

## Инварианты (обязательные ограничения)

База данных должна гарантировать:

1. **Заказ нельзя оплатить дважды** (нельзя дважды перевести заказ в статус `paid`)
2. Итоговая сумма заказа не может быть отрицательной
3. Количество товара в позиции не может быть ≤ 0
4. Цена товара в позиции не может быть отрицательной
5. Email пользователя должен быть уникальным

Ограничения должны быть реализованы средствами СУБД:
- `CHECK`
- `UNIQUE`
- `FOREIGN KEY`
- `NOT NULL`
- другие механизмы (при необходимости)

## Что нужно реализовать

### 1. Доменный слой (`backend/app/domain/`)

Реализуйте классы в следующих файлах:

#### `user.py`
- Класс `User` с полями: `email`, `name`, `id`, `created_at`
- Валидация email через regex в `__post_init__`

#### `order.py`
- Enum `OrderStatus` со статусами
- Класс `OrderItem` с валидацией цены и количества
- Класс `OrderStatusChange` для истории
- Класс `Order` с методами:
  - `add_item()` - добавление товара
  - `pay()` - оплата (КРИТИЧНО: нельзя оплатить дважды!)
  - `cancel()` - отмена
  - `ship()` - отправка
  - `complete()` - завершение

### 2. Репозитории (`backend/app/infrastructure/repositories.py`)

Реализуйте методы для работы с БД:

**UserRepository:**
- `save()` - сохранение пользователя
- `find_by_id()` - поиск по ID
- `find_by_email()` - поиск по email
- `find_all()` - список всех пользователей

**OrderRepository:**
- `save()` - сохранение заказа с товарами и историей
- `find_by_id()` - загрузка заказа со всеми данными
- `find_by_user()` - заказы пользователя
- `find_all()` - все заказы

### 3. Сервисы (`backend/app/application/`)

**UserService (`user_service.py`):**
- `register()` - регистрация пользователя
- `get_by_id()` - получение по ID
- `get_by_email()` - получение по email
- `list_users()` - список пользователей

**OrderService (`order_service.py`):**
- `create_order()` - создание заказа
- `add_item()` - добавление товара
- `pay_order()` - оплата заказа
- `cancel_order()` - отмена заказа
- `ship_order()` - отправка заказа
- `complete_order()` - завершение заказа
- `list_orders()` - список заказов
- `get_order_history()` - история статусов

### 4. SQL Миграция (`backend/migrations/001_init.sql`)

Создайте схему БД с:

**Таблицами:**
- `order_statuses` - справочник статусов
- `users` - пользователи
- `orders` - заказы
- `order_items` - товары в заказах
- `order_status_history` - история статусов

**Обязательными ограничениями (constraints):**
- Email уникален и валиден (regex)
- Цена >= 0
- Количество > 0
- Сумма заказа >= 0
- Внешние ключи с CASCADE

**Триггером:**
- **КРИТИЧЕСКИЙ**: Запрет двойной оплаты заказа

**Бонусные триггеры (опционально):**
- Автоматический пересчет `total_amount`
- Автоматическая запись изменений статуса в историю

## Запуск проекта

```bash
# Запуск через Docker
docker-compose up --build

# Проверка
curl http://localhost:8080/health
open http://localhost:5173
```

## Тестирование

```bash
cd backend
export PYTHONPATH=$(pwd)

# Запустить все доменные тесты
pytest app/tests/test_domain.py -v

# Запустить критический тест на двойную оплату
pytest app/tests/test_domain.py::TestCriticalPaymentInvariant -v
```

## Требования к реализации

Вы должны:

1. ✅ Спроектировать структуру таблиц
2. ✅ Описать все ограничения целостности
3. ✅ Реализовать SQL-миграции (DDL-скрипт)
4. ✅ Реализовать доменные модели с валидацией
5. ✅ Реализовать репозитории для работы с БД
6. ✅ Реализовать сервисы прикладного уровня
7. ✅ Продемонстрировать работу инвариантов

## Проверка корректности

При проверке лабораторной работы будет оцениваться:

- Корректность схемы БД
- Реализация всех обязательных инвариантов
- Качество ограничений на уровне СУБД
- Прохождение всех тестов
- Работа критического инварианта "нельзя оплатить дважды"

## Дополнительное задание (бонус)

1. Автоматическое обновление `total_amount` через триггеры
2. Автоматическая запись в историю при изменении статуса
3. Запись начального статуса при создании заказа

## Критерии оценки

- **Корректность схемы** — 30%
- **Реализация инвариантов** — 30%
- **Качество ограничений на уровне БД** — 20%
- **Тестирование граничных случаев** — 10%
- **Обоснование решений** — 10%

## Запрещается

- Реализовывать инварианты только в коде приложения
- Оставлять поля без ограничений, если их можно формализовать
- Использовать тип TEXT без обоснования

## Структура проекта

```
lab_01/
├── backend/
│   ├── app/
│   │   ├── domain/              # TODO: Реализовать доменные модели
│   │   ├── infrastructure/      # TODO: Реализовать репозитории
│   │   ├── application/         # TODO: Реализовать сервисы
│   │   ├── api/                 # ✅ Готово
│   │   └── tests/               # ✅ Тесты (НЕ ИЗМЕНЯТЬ!)
│   └── migrations/
│       └── 001_init.sql         # TODO: Создать схему БД
├── frontend/                    # ✅ Готово
├── docker-compose.yml
├── README.md                    # Этот файл
└── QUICKSTART.md                # Инструкция по запуску
```

## Важно!

**Главное требование:** Заказ нельзя оплатить дважды. Это должно быть гарантировано на двух уровнях:
1. **Доменная модель** (Python) - в методе `Order.pay()`
2. **База данных** (PostgreSQL) - через триггер

## Подсказки

См. файл `QUICKSTART.md` для быстрого старта и подсказок по реализации.
